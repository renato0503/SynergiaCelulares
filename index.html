<!DOCTYPE html>
<html lang="pt-BR" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Simulador ERP — Empresa ALFA</title>

  <script>
    tailwind = { config: {
      theme: {
        extend: {
          colors: {
            brand: {
              25:  '#faf7ff',
              50:  '#f5f1ff',
              100: '#ebe4ff',
              200: '#d9c9ff',
              300: '#c2a6ff',
              400: '#a77cff',
              500: '#8b5cf6', /* violet-500 base */
              600: '#7c3aed', /* violet-600 */
              700: '#6d28d9', /* violet-700 */
              800: '#4c1d95', /* violet-900-ish */
              900: '#2e1065'
            }
          },
          boxShadow: {
            card: '0 8px 20px rgba(0,0,0,0.08)'
          }
        }
      }
    }};
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <script crossorigin defer src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin defer src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script defer src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <meta name="color-scheme" content="dark light">
</head>
<body class="h-full bg-black text-white selection:bg-brand-600 selection:text-white">
  <a href="#conteudo" class="sr-only focus:not-sr-only focus:fixed focus:z-50 focus:top-4 focus:left-4 focus:bg-black focus:text-white focus:outline-none focus:ring-2 focus:ring-white px-3 py-2 rounded-lg">Ir para o conteúdo</a>

  <!-- App Shell com cabeçalho fixo e área segura -->
  <header class="fixed inset-x-0 top-0 z-40 backdrop-blur supports-[backdrop-filter]:bg-black/50 bg-black/70 border-b border-white/10"
          style="padding-top: env(safe-area-inset-top)">
    <div class="max-w-7xl mx-auto px-4 sm:px-6">
      <div class="h-16 flex items-center justify-between">
        <div class="min-w-0">
          <h1 class="text-base sm:text-lg font-semibold tracking-tight">
            <span class="bg-gradient-to-r from-brand-400 via-brand-600 to-white bg-clip-text text-transparent">Simulador ERP — Empresa ALFA</span>
          </h1>
          <p class="text-xs sm:text-sm text-white/70">Custos fichas técnicas margens KPIs e ponto de equilíbrio</p>
        </div>
        <div class="hidden sm:flex gap-2">
          <button id="btn-reset-desktop" class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 active:bg-white/30 focus:outline-none focus-visible:ring-2 focus-visible:ring-white text-white"
                  aria-label="Recarregar dados">Recarregar</button>
          <button id="btn-novo-desktop" class="px-3 py-2 rounded-xl bg-gradient-to-br from-brand-600 to-brand-800 hover:from-brand-500 hover:to-brand-700 active:from-brand-600 active:to-brand-900 text-white shadow-card focus:outline-none focus-visible:ring-2 focus-visible:ring-white"
                  aria-label="Novo produto">Novo produto</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Barra de ações fixa no mobile -->
  <div class="fixed inset-x-0 bottom-0 z-40 bg-black/80 backdrop-blur border-t border-white/10 sm:hidden"
       style="padding-bottom: calc(env(safe-area-inset-bottom) + 0px)">
    <div class="max-w-7xl mx-auto px-4 py-3 grid grid-cols-2 gap-3">
      <button id="btn-reset-mobile" class="w-full h-12 rounded-xl bg-white/10 hover:bg-white/20 active:bg-white/30 text-white text-sm font-medium focus:outline-none focus-visible:ring-2 focus-visible:ring-white">Recarregar</button>
      <button id="btn-novo-mobile" class="w-full h-12 rounded-xl bg-gradient-to-br from-brand-600 to-brand-800 hover:from-brand-500 hover:to-brand-700 text-white text-sm font-medium shadow-card focus:outline-none focus-visible:ring-2 focus-visible:ring-white">Novo produto</button>
    </div>
  </div>

  <main id="conteudo" class="pt-20 pb-24 sm:pb-10">
    <div id="root" class="max-w-7xl mx-auto px-4 sm:px-6"></div>
  </main>

  <script type="text/babel">
    const { useMemo, useState } = React;

    function uid() { return Math.random().toString(36).slice(2, 10); }

    const CURRENCIES = ["BRL", "USD"];

    function seed() {
      const sp1 = { id: uid(), name: "FoxParts", country: "CN" };
      const sp2 = { id: uid(), name: "BR Placas", country: "BR" };
      const sp3 = { id: uid(), name: "GlassCo", country: "US" };

      const cc1 = { id: uid(), name: "Logística", monthlyCost: 180000 };
      const cc2 = { id: uid(), name: "Qualidade", monthlyCost: 120000 };
      const cc3 = { id: uid(), name: "Administrativo", monthlyCost: 90000 };

      const p1 = { id: uid(), name: "ALFA X1", sku: "AX1", channel: "Varejo", price: 1800, leadTimeDays: 7, reworkRate: 0.02, returnRate: 0.015 };
      const p2 = { id: uid(), name: "ALFA M Pro", sku: "AMP", channel: "Online", price: 2400, leadTimeDays: 10, reworkRate: 0.03, returnRate: 0.02 };
      const p3 = { id: uid(), name: "ALFA Lite", sku: "ALT", channel: "Distribuidor", price: 1200, leadTimeDays: 5, reworkRate: 0.015, returnRate: 0.025 };

      const bom = [
        { id: uid(), productId: p1.id, component: "Tela 6.1", qty: 1, unitCost: 35, currency: "USD", supplierId: sp3.id },
        { id: uid(), productId: p1.id, component: "Placa lógica X1", qty: 1, unitCost: 420, currency: "BRL", supplierId: sp2.id },
        { id: uid(), productId: p1.id, component: "Bateria 4000mAh", qty: 1, unitCost: 12, currency: "USD", supplierId: sp1.id },
        { id: uid(), productId: p2.id, component: "Tela 6.7 OLED", qty: 1, unitCost: 70, currency: "USD", supplierId: sp3.id },
        { id: uid(), productId: p2.id, component: "Placa lógica M Pro", qty: 1, unitCost: 680, currency: "BRL", supplierId: sp2.id },
        { id: uid(), productId: p2.id, component: "Bateria 5000mAh", qty: 1, unitCost: 18, currency: "USD", supplierId: sp1.id },
        { id: uid(), productId: p3.id, component: "Tela 5.8", qty: 1, unitCost: 25, currency: "USD", supplierId: sp3.id },
        { id: uid(), productId: p3.id, component: "Placa lógica Lite", qty: 1, unitCost: 300, currency: "BRL", supplierId: sp2.id },
        { id: uid(), productId: p3.id, component: "Bateria 3500mAh", qty: 1, unitCost: 9, currency: "USD", supplierId: sp1.id },
      ];

      const labors = [
        { id: uid(), productId: p1.id, minutes: 22, hourlyRate: 38 },
        { id: uid(), productId: p2.id, minutes: 28, hourlyRate: 42 },
        { id: uid(), productId: p3.id, minutes: 18, hourlyRate: 35 },
      ];

      const taxes = [
        { id: uid(), productId: p1.id, freightPerUnit: 35, salesTaxRate: 0.22 },
        { id: uid(), productId: p2.id, freightPerUnit: 45, salesTaxRate: 0.22 },
        { id: uid(), productId: p3.id, freightPerUnit: 25, salesTaxRate: 0.18 },
      ];

      const plan = [
        { id: uid(), productId: p1.id, unitsPerMonth: 2500 },
        { id: uid(), productId: p2.id, unitsPerMonth: 1500 },
        { id: uid(), productId: p3.id, unitsPerMonth: 4000 },
      ];

      return { suppliers: [sp1, sp2, sp3], costCenters: [cc1, cc2, cc3], products: [p1, p2, p3], bom, labors, taxes, plan };
    }

    const fmt = (n) => n.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    const pct = (n) => (n * 100).toFixed(1) + "%";

    function useERPState() {
      const s = seed();
      const [state, setState] = useState({ ...s, fxUSD: 5.20, scenarioTaxAdder: 0 });
      function resetSeed() { const s2 = seed(); setState((old) => ({ ...old, ...s2 })); }
      function addProduct() {
        const p = { id: uid(), name: "Novo", sku: "SKU" + Math.floor(Math.random() * 999), channel: "Varejo", price: 1000, leadTimeDays: 7, reworkRate: 0.02, returnRate: 0.02 };
        const plan = { id: uid(), productId: p.id, unitsPerMonth: 500 };
        const tax = { id: uid(), productId: p.id, freightPerUnit: 20, salesTaxRate: 0.2 };
        const lab = { id: uid(), productId: p.id, minutes: 20, hourlyRate: 35 };
        setState((st) => ({ ...st, products: [...st.products, p], plan: [...st.plan, plan], taxes: [...st.taxes, tax], labors: [...st.labors, lab] }));
      }
      return { state, setState, resetSeed, addProduct };
    }

    function useCalculations(state) {
      const { products, bom, labors, taxes, costCenters, plan, fxUSD, scenarioTaxAdder } = state;
      const monthlyFixedOverhead = useMemo(() => costCenters.reduce((s, c) => s + c.monthlyCost, 0), [costCenters]);
      const productionMap = useMemo(() => { const m = new Map(); plan.forEach((p) => m.set(p.productId, p.unitsPerMonth)); return m; }, [plan]);
      const prodTotals = useMemo(() => {
        return products.map((prod) => {
          const units = productionMap.get(prod.id) || 0;
          const bomItems = bom.filter((b) => b.productId === prod.id);
          const labor = labors.find((l) => l.productId === prod.id);
          const tax = taxes.find((t) => t.productId === prod.id);
          const materialUnit = bomItems.reduce((s, it) => { const unitCostBRL = it.currency === "USD" ? it.unitCost * fxUSD : it.unitCost; return s + unitCostBRL * it.qty; }, 0);
          const laborUnit = labor ? (labor.minutes / 60) * labor.hourlyRate : 0;
          const freightUnit = tax ? tax.freightPerUnit : 0;
          const variableUnit = materialUnit + laborUnit + freightUnit;
          const revenue = prod.price * units;
          const salesTaxRate = (tax?.salesTaxRate || 0) + scenarioTaxAdder;
          const salesTaxes = revenue * Math.max(0, salesTaxRate);
          const totalUnitsMonth = plan.reduce((s, p) => s + p.unitsPerMonth, 0) || 1;
          const fixedShare = monthlyFixedOverhead * (units / totalUnitsMonth);
          const fixedPerUnit = units > 0 ? fixedShare / units : 0;
          const fullUnitCost = variableUnit + fixedPerUnit;
          const contributionUnit = prod.price - variableUnit;
          const contributionTotal = contributionUnit * units;
          const operatingResult = revenue - salesTaxes - variableUnit * units - fixedShare;
          const breakEvenUnits = contributionUnit > 0 ? Math.ceil(fixedShare / contributionUnit) : Infinity;
          return { product: prod, units, materialUnit, laborUnit, freightUnit, variableUnit, fixedPerUnit, fullUnitCost, revenue, salesTaxes, contributionUnit, contributionMarginPct: prod.price > 0 ? contributionUnit / prod.price : 0, contributionTotal, operatingResult, breakEvenUnits };
        });
      }, [products, productionMap, bom, labors, taxes, fxUSD, scenarioTaxAdder, monthlyFixedOverhead, plan]);

      const kpis = useMemo(() => {
        const totalRevenue = prodTotals.reduce((s, r) => s + r.revenue, 0);
        const totalSalesTaxes = prodTotals.reduce((s, r) => s + r.salesTaxes, 0);
        const totalVariable = prodTotals.reduce((s, r) => s + r.variableUnit * r.units, 0);
        const totalContribution = prodTotals.reduce((s, r) => s + r.contributionTotal, 0);
        const operatingIncome = totalRevenue - totalSalesTaxes - totalVariable - monthlyFixedOverhead;
        const avgCostPerUnit = (() => { const totalUnits = plan.reduce((s, p) => s + p.unitsPerMonth, 0) || 1; const totalFullCost = prodTotals.reduce((s, r) => s + r.fullUnitCost * r.units, 0); return totalFullCost / totalUnits; })();
        const weightedReturnRate = (() => { const totalUnits = plan.reduce((s, p) => s + p.unitsPerMonth, 0) || 1; return products.reduce((acc, p) => { const u = plan.find((x) => x.productId === p.id)?.unitsPerMonth || 0; return acc + p.returnRate * (u / totalUnits); }, 0); })();
        return { totalRevenue, totalSalesTaxes, totalVariable, monthlyFixedOverhead, totalContribution, operatingIncome, avgCostPerUnit, weightedReturnRate };
      }, [prodTotals, plan, products, monthlyFixedOverhead]);

      return { prodTotals, kpis };
    }

    function Field({ label, htmlFor, children, help }) {
      return (
        <div className="grid gap-1">
          <label htmlFor={htmlFor} className="text-sm text-white/80">{label}</label>
          {children}
          {help ? <p className="text-xs text-white/60">{help}</p> : null}
        </div>
      );
    }

    function NumberInput({ value, onChange, step = 1, min = 0, id }) {
      return (
        <input
          id={id}
          type="number"
          className="w-full rounded-xl bg-white/5 border border-white/10 px-3 py-2 text-white placeholder-white/40 focus:outline-none focus-visible:ring-2 focus-visible:ring-white"
          value={Number.isFinite(value) ? value : 0}
          step={step}
          min={min}
          onChange={(e) => onChange(parseFloat(e.target.value || "0"))}
          inputMode="decimal"
        />
      );
    }

    function Input({ value, onChange, id, placeholder }) {
      return (
        <input
          id={id}
          className="w-full rounded-xl bg-white/5 border border-white/10 px-3 py-2 text-white placeholder-white/40 focus:outline-none focus-visible:ring-2 focus-visible:ring-white"
          value={value}
          placeholder={placeholder}
          onChange={(e) => onChange(e.target.value)}
        />
      );
    }

    function Select({ value, onChange, id, children }) {
      return (
        <select
          id={id}
          className="w-full rounded-xl bg-white/5 border border-white/10 px-3 py-2 text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-white"
          value={value}
          onChange={(e) => onChange(e.target.value)}
        >
          {children}
        </select>
      );
    }

    function Card({ children, className = "" }) {
      return (
        <div className={`rounded-2xl bg-gradient-to-b from-brand-900/40 to-black border border-white/10 shadow-card ${className}`}>
          {children}
        </div>
      );
    }

    function SectionHeader({ title, action }) {
      return (
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-lg font-semibold text-white">{title}</h3>
          {action}
        </div>
      );
    }

    function SimpleTable({ cols, rows, rowKey }) {
      return (
        <div className="overflow-x-auto rounded-xl ring-1 ring-white/10">
          <table className="min-w-full text-sm">
            <thead>
              <tr className="bg-white/5 text-white/80">
                {cols.map((c, i) => (
                  <th key={i} className="text-left px-3 py-2 font-medium">{c.header}</th>
                ))}
              </tr>
            </thead>
            <tbody>
              {rows.map((r, i) => (
                <tr key={rowKey(r, i)} className="border-t border-white/10">
                  {cols.map((c, j) => (
                    <td key={j} className="px-3 py-2 align-top">{c.render(r, i)}</td>
                  ))}
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      );
    }

    function toCSV(rows, columns) {
      const esc = (v) => `"${String(v ?? "").replace(/"/g, '""')}"`;
      const header = columns.map(esc).join(",");
      const lines = rows.map((r) => columns.map((c) => esc(r[c])).join(","));
      return [header, ...lines].join("\n");
    }
    function download(name, content) {
      const blob = new Blob([content], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href = url; a.download = name; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    function CadastroProdutos({ state, setState }) {
      function update(prodId, patch) { setState((st) => ({ ...st, products: st.products.map((p) => (p.id === prodId ? { ...p, ...patch } : p)) })); }
      function supplierDefault(st) { return st.suppliers[0]?.id || ""; }
      function addBom(prodId) { const it = { id: uid(), productId: prodId, component: "Componente", qty: 1, unitCost: 10, currency: "BRL", supplierId: supplierDefault(state) }; setState((st) => ({ ...st, bom: [...st.bom, it] })); }
      function updateBom(itId, patch) { setState((st) => ({ ...st, bom: st.bom.map((b) => (b.id === itId ? { ...b, ...patch } : b)) })); }
      function removeBom(itId) { setState((st) => ({ ...st, bom: st.bom.filter((b) => b.id !== itId) })); }
      function updateLabor(prodId, patch) { setState((st) => ({ ...st, labors: st.labors.map((l) => (l.productId === prodId ? { ...l, ...patch } : l)) })); }
      function updateTax(prodId, patch) { setState((st) => ({ ...st, taxes: st.taxes.map((t) => (t.productId === prodId ? { ...t, ...patch } : t)) })); }
      function updatePlan(prodId, unitsPerMonth) { setState((st) => ({ ...st, plan: st.plan.map((p) => (p.productId === prodId ? { ...p, unitsPerMonth } : p)) })); }

      return (
        <div className="grid gap-6">
          {state.products.map((p) => {
            const labor = state.labors.find((l) => l.productId === p.id);
            const tax = state.taxes.find((t) => t.productId === p.id);
            const units = state.plan.find((pl) => pl.productId === p.id)?.unitsPerMonth || 0;
            const items = state.bom.filter((b) => b.productId === p.id);
            return (
              <Card key={p.id} className="p-6">
                <div className="flex items-center justify-between mb-4">
                  <h4 className="text-base font-semibold">{p.name} — {p.sku}</h4>
                  <button className="text-sm px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 active:bg-white/30 focus:outline-none focus-visible:ring-2 focus-visible:ring-white"
                          onClick={() => addBom(p.id)}>Adicionar componente</button>
                </div>

                <div className="grid md:grid-cols-4 gap-4">
                  <Field label="Nome"><Input value={p.name} onChange={(v) => update(p.id, { name: v })} /></Field>
                  <Field label="SKU"><Input value={p.sku} onChange={(v) => update(p.id, { sku: v })} /></Field>
                  <Field label="Canal">
                    <Select value={p.channel} onChange={(v) => update(p.id, { channel: v })}>
                      <option>Varejo</option><option>Online</option><option>Distribuidor</option>
                    </Select>
                  </Field>
                  <Field label="Preço BRL"><NumberInput value={p.price} onChange={(n) => update(p.id, { price: n })} step={10} /></Field>

                  <Field label="Lead time dias"><NumberInput value={p.leadTimeDays} onChange={(n) => update(p.id, { leadTimeDays: n })} /></Field>
                  <Field label="Retrabalho %"><NumberInput value={p.reworkRate} onChange={(n) => update(p.id, { reworkRate: n })} step={0.005} /></Field>
                  <Field label="Devolução %"><NumberInput value={p.returnRate} onChange={(n) => update(p.id, { returnRate: n })} step={0.005} /></Field>
                  <Field label="Plano unidades mês"><NumberInput value={units} onChange={(n) => updatePlan(p.id, n)} step={50} /></Field>

                  <Field label="Mão de obra min/unid"><NumberInput value={labor?.minutes || 0} onChange={(n) => updateLabor(p.id, { minutes: n })} /></Field>
                  <Field label="Custo hora BRL"><NumberInput value={labor?.hourlyRate || 0} onChange={(n) => updateLabor(p.id, { hourlyRate: n })} step={1} /></Field>
                  <Field label="Frete por unidade BRL"><NumberInput value={tax?.freightPerUnit || 0} onChange={(n) => updateTax(p.id, { freightPerUnit: n })} step={1} /></Field>
                  <Field label="Alíquota sobre vendas %"><NumberInput value={tax?.salesTaxRate || 0} onChange={(n) => updateTax(p.id, { salesTaxRate: n })} step={0.01} /></Field>
                </div>

                <div className="mt-6">
                  <div className="text-sm font-medium text-white/90 mb-2">Ficha técnica</div>
                  <SimpleTable
                    cols={[
                      { header: "Componente", render: (r) => <Input value={r.component} onChange={(v) => updateBom(r.id, { component: v })} /> },
                      { header: "Qtd", render: (r) => <NumberInput value={r.qty} onChange={(n) => updateBom(r.id, { qty: n })} step={0.1} /> },
                      { header: "Custo unitário", render: (r) => <NumberInput value={r.unitCost} onChange={(n) => updateBom(r.id, { unitCost: n })} step={1} /> },
                      { header: "Moeda", render: (r) => (
                        <Select value={r.currency} onChange={(v) => updateBom(r.id, { currency: v })}>
                          {CURRENCIES.map((c) => <option key={c} value={c}>{c}</option>)}
                        </Select>
                      )},
                      { header: "Fornecedor", render: (r) => (
                        <Select value={r.supplierId} onChange={(v) => updateBom(r.id, { supplierId: v })}>
                          {state.suppliers.map((s) => <option key={s.id} value={s.id}>{s.name}</option>)}
                        </Select>
                      )},
                      { header: "Ação", render: (r) => (
                        <button className="px-3 py-2 rounded-lg bg-white/5 hover:bg-white/15 text-rose-300 hover:text-rose-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-white"
                                onClick={() => removeBom(r.id)} aria-label={`Remover ${r.component}`}>Remover</button>
                      )}
                    ]}
                    rows={items}
                    rowKey={(r) => r.id}
                  />
                </div>
              </Card>
            );
          })}
        </div>
      );
    }

    function CentrosCustos({ state, setState }) {
      function update(ccId, patch) { setState((st) => ({ ...st, costCenters: st.costCenters.map((c) => (c.id === ccId ? { ...c, ...patch } : c)) })); }
      function add() { setState((st) => ({ ...st, costCenters: [...st.costCenters, { id: uid(), name: "Centro", monthlyCost: 50000 }] })); }
      function remove(ccId) { setState((st) => ({ ...st, costCenters: st.costCenters.filter((c) => c.id !== ccId) })); }
      return (
        <Card className="p-6">
          <SectionHeader
            title="Centros de custo"
            action={<button className="text-sm px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 active:bg-white/30 focus:outline-none focus-visible:ring-2 focus-visible:ring-white" onClick={add}>Adicionar</button>}
          />
          <SimpleTable
            cols={[
              { header: "Nome", render: (r) => <Input value={r.name} onChange={(v) => update(r.id, { name: v })} /> },
              { header: "Custo mensal", render: (r) => <NumberInput value={r.monthlyCost} onChange={(n) => update(r.id, { monthlyCost: n })} step={1000} /> },
              { header: "Ação", render: (r) => <button className="px-3 py-2 rounded-lg bg-white/5 hover:bg-white/15 focus:outline-none focus-visible:ring-2 focus-visible:ring-white" onClick={() => remove(r.id)}>Remover</button> }
            ]}
            rows={state.costCenters}
            rowKey={(r) => r.id}
          />
        </Card>
      );
    }

    function Fornecedores({ state, setState }) {
      function update(id, patch) { setState((st) => ({ ...st, suppliers: st.suppliers.map((s) => (s.id === id ? { ...s, ...patch } : s)) })); }
      function add() { setState((st) => ({ ...st, suppliers: [...st.suppliers, { id: uid(), name: "Fornecedor", country: "BR" }] })); }
      function remove(id) { setState((st) => ({ ...st, suppliers: st.suppliers.filter((s) => s.id !== id) })); }
      return (
        <Card className="p-6">
          <SectionHeader
            title="Fornecedores"
            action={<button className="text-sm px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 active:bg-white/30 focus:outline-none focus-visible:ring-2 focus-visible:ring-white" onClick={add}>Adicionar</button>}
          />
          <SimpleTable
            cols={[
              { header: "Nome", render: (r) => <Input value={r.name} onChange={(v) => update(r.id, { name: v })} /> },
              { header: "País", render: (r) => <Input value={r.country} onChange={(v) => update(r.id, { country: v })} /> },
              { header: "Ação", render: (r) => <button className="px-3 py-2 rounded-lg bg-white/5 hover:bg-white/15 focus:outline-none focus-visible:ring-2 focus-visible:ring-white" onClick={() => remove(r.id)}>Remover</button> }
            ]}
            rows={state.suppliers}
            rowKey={(r) => r.id}
          />
        </Card>
      );
    }

    function RelatorioCustos({ state }) {
      const { prodTotals } = useCalculations(state);
      const rows = prodTotals.map((r) => ({
        produto: r.product.name, sku: r.product.sku, canal: r.product.channel, preco: r.product.price, unidades: r.units,
        material_unitario: r.materialUnit, mao_de_obra_unitario: r.laborUnit, frete_unitario: r.freightUnit, custo_fixo_unitario: r.fixedPerUnit,
        custo_total_unitario: r.fullUnitCost, margem_contribuicao_unitaria: r.contributionUnit, margem_contribuicao_pct: r.contributionMarginPct,
        impostos: r.salesTaxes, receita: r.revenue, resultado_operacional: r.operatingResult, ponto_de_equilibrio_unid: r.breakEvenUnits
      }));
      function exportar() { const cols = Object.keys(rows[0] || {}); const csv = toCSV(rows, cols); download("relatorio_custos.csv", csv); }

      return (
        <Card className="p-6">
          <SectionHeader
            title="Relatório de custos e margens por produto"
            action={<button className="text-sm px-3 py-2 rounded-xl bg-gradient-to-br from-brand-600 to-brand-800 hover:from-brand-500 hover:to-brand-700 text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-white" onClick={exportar}>Exportar CSV</button>}
          />

          {/* Tabela para telas médias e maiores */}
          <div className="hidden md:block">
            <div className="overflow-x-auto rounded-xl ring-1 ring-white/10">
              <table className="min-w-full text-sm">
                <thead>
                  <tr className="bg-white/5 text-white/80">
                    {['Produto','SKU','Canal','Preço','Unidades','Materiais','Mão de obra','Frete','Fixo unit.','Custo unit.','MC unit.','MC %','Impostos','Receita','Resultado','PE unid'].map((h) => <th key={h} className="text-left px-3 py-2 font-medium">{h}</th>)}
                  </tr>
                </thead>
                <tbody>
                  {prodTotals.map((r) => (
                    <tr key={r.product.id} className="border-t border-white/10">
                      <td className="px-3 py-2">{r.product.name}</td>
                      <td className="px-3 py-2">{r.product.sku}</td>
                      <td className="px-3 py-2">{r.product.channel}</td>
                      <td className="px-3 py-2">{fmt(r.product.price)}</td>
                      <td className="px-3 py-2">{r.units.toLocaleString('pt-BR')}</td>
                      <td className="px-3 py-2">{fmt(r.materialUnit)}</td>
                      <td className="px-3 py-2">{fmt(r.laborUnit)}</td>
                      <td className="px-3 py-2">{fmt(r.freightUnit)}</td>
                      <td className="px-3 py-2">{fmt(r.fixedPerUnit)}</td>
                      <td className="px-3 py-2">{fmt(r.fullUnitCost)}</td>
                      <td className="px-3 py-2">{fmt(r.contributionUnit)}</td>
                      <td className="px-3 py-2">{pct(r.contributionMarginPct)}</td>
                      <td className="px-3 py-2">{fmt(r.salesTaxes)}</td>
                      <td className="px-3 py-2">{fmt(r.revenue)}</td>
                      <td className={`px-3 py-2 ${r.operatingResult >= 0 ? 'text-emerald-300' : 'text-rose-300'}`}>{fmt(r.operatingResult)}</td>
                      <td className="px-3 py-2">{Number.isFinite(r.breakEvenUnits) ? r.breakEvenUnits.toLocaleString('pt-BR') : '—'}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>

          {/* Cartões empilhados no mobile */}
          <div className="md:hidden grid gap-3">
            {prodTotals.map((r) => (
              <div key={r.product.id} className="rounded-xl bg-white/5 border border-white/10 p-4">
                <div className="flex items-center justify-between mb-2">
                  <div className="font-medium">{r.product.name}</div>
                  <div className="text-xs text-white/60">{r.product.sku}</div>
                </div>
                <dl className="grid grid-cols-2 gap-2 text-sm">
                  <div><dt className="text-white/60">Canal</dt><dd>{r.product.channel}</dd></div>
                  <div><dt className="text-white/60">Preço</dt><dd>{fmt(r.product.price)}</dd></div>
                  <div><dt className="text-white/60">Unidades</dt><dd>{r.units.toLocaleString('pt-BR')}</dd></div>
                  <div><dt className="text-white/60">Materiais</dt><dd>{fmt(r.materialUnit)}</dd></div>
                  <div><dt className="text-white/60">Mão de obra</dt><dd>{fmt(r.laborUnit)}</dd></div>
                  <div><dt className="text-white/60">Frete</dt><dd>{fmt(r.freightUnit)}</dd></div>
                  <div><dt className="text-white/60">Fixo unit.</dt><dd>{fmt(r.fixedPerUnit)}</dd></div>
                  <div><dt className="text-white/60">Custo unit.</dt><dd>{fmt(r.fullUnitCost)}</dd></div>
                  <div><dt className="text-white/60">MC unit.</dt><dd>{fmt(r.contributionUnit)}</dd></div>
                  <div><dt className="text-white/60">MC %</dt><dd>{pct(r.contributionMarginPct)}</dd></div>
                  <div><dt className="text-white/60">Impostos</dt><dd>{fmt(r.salesTaxes)}</dd></div>
                  <div><dt className="text-white/60">Receita</dt><dd>{fmt(r.revenue)}</dd></div>
                  <div className="col-span-2"><dt className="text-white/60">Resultado</dt><dd className={`${r.operatingResult >= 0 ? 'text-emerald-300' : 'text-rose-300'}`}>{fmt(r.operatingResult)}</dd></div>
                  <div className="col-span-2"><dt className="text-white/60">PE unid</dt><dd>{Number.isFinite(r.breakEvenUnits) ? r.breakEvenUnits.toLocaleString('pt-BR') : '—'}</dd></div>
                </dl>
              </div>
            ))}
          </div>
        </Card>
      );
    }

    function KPIs({ state }) {
      const { kpis, prodTotals } = useCalculations(state);
      const top = [...prodTotals].sort((a, b) => b.contributionTotal - a.contributionTotal).slice(0, 3);
      const KPI = ({ label, value }) => (
        <div className="rounded-2xl bg-white/5 border border-white/10 p-6">
          <div className="text-sm text-white/70">{label}</div>
          <div className="text-2xl font-semibold mt-1">{value}</div>
        </div>
      );
      return (
        <div className="grid md:grid-cols-3 gap-4">
          <KPI label="Receita mensal" value={fmt(kpis.totalRevenue)} />
          <KPI label="Impostos s vendas" value={fmt(kpis.totalSalesTaxes)} />
          <KPI label="Custos variáveis" value={fmt(kpis.totalVariable)} />
          <KPI label="Custos fixos" value={fmt(kpis.monthlyFixedOverhead)} />
          <KPI label="Margem de contribuição" value={fmt(kpis.totalContribution)} />
          <KPI label="Resultado operacional" value={fmt(kpis.operatingIncome)} />
          <KPI label="Custo médio por unidade" value={fmt(kpis.avgCostPerUnit)} />
          <div className="rounded-2xl bg-white/5 border border-white/10 p-6 md:col-span-2">
            <div className="text-sm text-white/70 mb-1">Produtos com maior efeito na margem</div>
            <div className="space-y-1">
              {top.map((r) => (<div key={r.product.id} className="text-sm">{r.product.name} — {fmt(r.contributionTotal)}</div>))}
            </div>
          </div>
        </div>
      );
    }

    function Cenarios({ state, setState }) {
      const { prodTotals } = useCalculations(state);
      return (
        <Card className="p-6">
          <SectionHeader
            title="Simulação de cenários"
            action={
              <button className="text-sm px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 active:bg-white/30 focus:outline-none focus-visible:ring-2 focus-visible:ring-white"
                      onClick={() => setState((st) => ({ ...st, fxUSD: 5.20, scenarioTaxAdder: 0 }))}>Padronizar</button>
            }
          />
          <div className="grid md:grid-cols-4 gap-4 mb-4">
            <Field label="Câmbio USD BRL"><NumberInput value={state.fxUSD} onChange={(n) => setState((st) => ({ ...st, fxUSD: n }))} step={0.05} /></Field>
            <Field label="Ajuste tributário +%"><NumberInput value={state.scenarioTaxAdder} onChange={(n) => setState((st) => ({ ...st, scenarioTaxAdder: n }))} step={0.01} /></Field>
            <div className="md:col-span-2 flex items-end text-sm text-white/60">Custos em USD reagem ao câmbio e o ajuste altera a alíquota de vendas</div>
          </div>

          {/* Tabela desktop */}
          <div className="hidden md:block">
            <div className="overflow-x-auto rounded-xl ring-1 ring-white/10">
              <table className="min-w-full text-sm">
                <thead><tr className="bg-white/5 text-white/80"><th className="px-3 py-2 text-left">Produto</th><th className="px-3 py-2 text-left">Custo unitário</th><th className="px-3 py-2 text-left">Margem contrib unid</th><th className="px-3 py-2 text-left">PE unidades</th></tr></thead>
                <tbody>
                  {prodTotals.map((r) => (
                    <tr key={r.product.id} className="border-t border-white/10">
                      <td className="px-3 py-2">{r.product.name}</td>
                      <td className="px-3 py-2">{fmt(r.fullUnitCost)}</td>
                      <td className="px-3 py-2">{fmt(r.contributionUnit)} ({pct(r.contributionMarginPct)})</td>
                      <td className="px-3 py-2">{Number.isFinite(r.breakEvenUnits) ? r.breakEvenUnits.toLocaleString('pt-BR') : '—'}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>

          {/* Cartões mobile */}
          <div className="md:hidden grid gap-3">
            {prodTotals.map((r) => (
              <div key={r.product.id} className="rounded-xl bg-white/5 border border-white/10 p-4">
                <div className="font-medium mb-1">{r.product.name}</div>
                <dl className="grid grid-cols-2 gap-2 text-sm">
                  <div><dt className="text-white/60">Custo unitário</dt><dd>{fmt(r.fullUnitCost)}</dd></div>
                  <div><dt className="text-white/60">MC unid</dt><dd>{fmt(r.contributionUnit)} ({pct(r.contributionMarginPct)})</dd></div>
                  <div className="col-span-2"><dt className="text-white/60">PE unidades</dt><dd>{Number.isFinite(r.breakEvenUnits) ? r.breakEvenUnits.toLocaleString('pt-BR') : '—'}</dd></div>
                </dl>
              </div>
            ))}
          </div>
        </Card>
      );
    }

    function Tabs({ active, setActive }) {
      const tabs = [
        { id: 'cadastro', label: 'Cadastro e fichas' },
        { id: 'centros', label: 'Centros de custo' },
        { id: 'fornecedores', label: 'Fornecedores' },
        { id: 'relatorios', label: 'Relatórios' },
        { id: 'kpis', label: 'KPIs' },
        { id: 'cenarios', label: 'Cenários' },
      ];
      return (
        <div className="flex flex-wrap gap-2">
          {tabs.map((t) => {
            const activeClasses = active === t.id
              ? 'bg-gradient-to-br from-brand-600 to-brand-800 text-white'
              : 'bg-white/5 text-white hover:bg-white/10';
            return (
              <button
                key={t.id}
                className={`px-4 py-2 rounded-xl border border-white/10 ${activeClasses} focus:outline-none focus-visible:ring-2 focus-visible:ring-white`}
                onClick={() => setActive(t.id)}
                aria-current={active === t.id ? 'page' : undefined}
              >
                {t.label}
              </button>
            );
          })}
        </div>
      );
    }

    function App() {
      const { state, setState, resetSeed, addProduct } = useERPState();
      const { kpis } = useCalculations(state);
      const [tab, setTab] = useState('cadastro');

      // Conecta botões fixos do cabeçalho e da barra móvel
      React.useEffect(() => {
        const br = document.getElementById('btn-reset-desktop');
        const bn = document.getElementById('btn-novo-desktop');
        const brm = document.getElementById('btn-reset-mobile');
        const bnm = document.getElementById('btn-novo-mobile');
        if (br) br.onclick = resetSeed;
        if (bn) bn.onclick = addProduct;
        if (brm) brm.onclick = resetSeed;
        if (bnm) bnm.onclick = addProduct;
      }, [resetSeed, addProduct]);

      return (
        <div className="space-y-6">
          <Card className="p-6">
            <div className="grid md:grid-cols-4 gap-4">
              <div><div className="text-sm text-white/70">Receita</div><div className="text-2xl font-semibold">{fmt(kpis.totalRevenue)}</div></div>
              <div><div className="text-sm text-white/70">Margem de contribuição</div><div className="text-2xl font-semibold">{fmt(kpis.totalContribution)}</div></div>
              <div><div className="text-sm text-white/70">Resultado operacional</div><div className="text-2xl font-semibold">{fmt(kpis.operatingIncome)}</div></div>
              <div><div className="text-sm text-white/70">Custo médio unitário</div><div className="text-2xl font-semibold">{fmt(kpis.avgCostPerUnit)}</div></div>
            </div>
          </Card>

          <Tabs active={tab} setActive={setTab} />

          {tab === 'cadastro' && <CadastroProdutos state={state} setState={setState} />}
          {tab === 'centros' && <CentrosCustos state={state} setState={setState} />}
          {tab === 'fornecedores' && <Fornecedores state={state} setState={setState} />}
          {tab === 'relatorios' && <RelatorioCustos state={state} />}
          {tab === 'kpis' && <KPIs state={state} />}
          {tab === 'cenarios' && <Cenarios state={state} setState={setState} />}

          <Card className="p-6 text-sm text-white/70">
            Cadastre produtos componentes mão de obra e plano de produção ajuste câmbio e alíquotas e avalie o efeito no custo unitário margem de contribuição resultado e ponto de equilíbrio exporte o relatório e use para discutir preço mix e volume os cálculos usam custeio por absorção para custo total com rateio proporcional ao volume e custeio variável para a margem de contribuição
          </Card>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>